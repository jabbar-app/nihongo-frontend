# PWA Implementation Guide

## Overview

The Manabou app now includes a fully functional Progressive Web App (PWA) implementation with an install prompt that encourages users to install the app on their devices.

## Features Implemented

### 1. PWA Install Prompt Component

**Location:** `components/pwa-install-prompt.tsx`

This component provides a beautiful, user-friendly popup that prompts users to install the app. Key features:

- **Smart Detection:**
  - Detects if the app is already installed (standalone mode)
  - Identifies iOS devices and shows appropriate instructions
  - Detects Android/Chrome devices and uses the native install prompt
  
- **User Experience:**
  - Appears 3 seconds after page load (non-intrusive timing)
  - Can be dismissed by the user
  - Remembers dismissal for 3 days using localStorage
  - Smooth slide-up animation
  - Responsive design (works on mobile and desktop)
  - Dark mode support

- **Platform-Specific Behavior:**
  - **iOS:** Shows instructions to use Share button → "Add to Home Screen"
  - **Android/Chrome:** Shows "Install Now" button that triggers the native install prompt
  - **Desktop:** Shows install prompt when available

### 2. PWA Configuration

**Service Worker:** Automatically generated by `@ducanh2912/next-pwa` package

**Manifest:** `public/manifest.json`
- App name: "Manabou – Learn Japanese"
- Theme color: #0d9488 (teal)
- Display mode: standalone
- Icons: 192x192 and 512x512 (maskable and regular)
- Orientation: portrait-primary
- Categories: education, productivity

**Next.js Config:** `next.config.ts`
- PWA enabled in production only
- Aggressive caching for better offline experience
- Auto-reload when connection is restored

### 3. Integration

The PWA install prompt is integrated into the root layout (`app/layout.tsx`) and appears globally across the app.

## How It Works

### For Users

1. **First Visit:**
   - User visits the app on a mobile device or supported browser
   - After 3 seconds, the install prompt appears at the bottom of the screen
   - User can either install the app or dismiss the prompt

2. **iOS Users:**
   - See instructions with visual guide to use Share button
   - Prompted to tap "Add to Home Screen"

3. **Android/Chrome Users:**
   - See "Install Now" button
   - Clicking triggers the native browser install prompt
   - Can choose to install or cancel

4. **After Installation:**
   - App opens in standalone mode (no browser UI)
   - Works offline with cached content
   - Appears on home screen like a native app

### For Developers

The PWA install prompt uses the `beforeinstallprompt` event:

```typescript
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  // Store the event for later use
  setDeferredPrompt(e);
  // Show custom install UI
  setShowPrompt(true);
});
```

## Testing

### Development Mode

PWA features are **disabled in development** to avoid caching issues. To test:

1. Build the production version:
   ```bash
   pnpm build
   ```

2. Start the production server:
   ```bash
   pnpm start
   ```

3. Open the app in your browser (preferably Chrome or Edge)

4. Wait 3 seconds for the install prompt to appear

### Testing on Mobile

1. Deploy the app to a production environment (or use ngrok/similar for local testing)
2. Open the app on your mobile device
3. Wait for the install prompt
4. Follow the installation instructions

### Testing Install Criteria

For the PWA install prompt to appear, the app must meet these criteria:

- ✅ Served over HTTPS (or localhost)
- ✅ Has a valid manifest.json with required fields
- ✅ Has a service worker registered
- ✅ Has appropriate icons (192x192 and 512x512)
- ✅ Not already installed

## Customization

### Change Prompt Timing

In `components/pwa-install-prompt.tsx`, modify the delay:

```typescript
setTimeout(() => {
  setShowPrompt(true);
}, 3000); // Change to desired milliseconds
```

### Change Dismissal Duration

Modify the localStorage check:

```typescript
const threeDaysInMs = 3 * 24 * 60 * 60 * 1000; // Change 3 to desired days
```

### Styling

The component uses Tailwind CSS classes. You can modify:
- Colors: Change `teal-600` to your preferred color
- Size: Adjust `max-w-sm` for different widths
- Position: Change `bottom-20 md:bottom-6` for different positioning

### Icons

The app uses a single brand icon set in `public/icons/`:
- `public/icons/icon-192x192.png` – favicon, PWA, Apple touch
- `public/icons/icon-512x512.png` – PWA, Open Graph / social / SEO

Replace these files to update the app icon everywhere (favicon, PWA, OG, Twitter, etc.).

## Browser Support

- ✅ Chrome/Edge (Android & Desktop)
- ✅ Safari (iOS - with manual instructions)
- ✅ Firefox (Android)
- ⚠️ Safari (macOS) - Limited support
- ❌ Internet Explorer - Not supported

## Troubleshooting

### Prompt Not Appearing

1. **Check if already installed:**
   - Open DevTools → Application → Manifest
   - Check if "App is installed" is shown

2. **Clear browser data:**
   - Clear site data and cache
   - Uninstall the PWA if already installed
   - Refresh the page

3. **Check console for errors:**
   - Open DevTools → Console
   - Look for service worker or manifest errors

4. **Verify HTTPS:**
   - PWA requires HTTPS (except localhost)
   - Check if your site is served over HTTPS

### Service Worker Issues

1. **Unregister old service worker:**
   ```javascript
   navigator.serviceWorker.getRegistrations().then(registrations => {
     registrations.forEach(registration => registration.unregister());
   });
   ```

2. **Hard refresh:**
   - Press Ctrl+Shift+R (Windows/Linux)
   - Press Cmd+Shift+R (Mac)

### iOS-Specific Issues

- iOS doesn't support the `beforeinstallprompt` event
- The component shows manual instructions instead
- Users must manually add to home screen via Share button

## Future Enhancements

Potential improvements:

1. **Analytics:** Track install prompt impressions and conversions
2. **A/B Testing:** Test different prompt designs and timings
3. **Smart Timing:** Show prompt after user engagement (e.g., after completing a lesson)
4. **Push Notifications:** Add web push notifications for study reminders
5. **Offline Functionality:** Enhance offline capabilities for better UX
6. **App Shortcuts:** Add quick actions to the installed app icon

## Resources

- [MDN PWA Guide](https://developer.mozilla.org/en-US/docs/Web/Progressive_web_apps)
- [Web.dev PWA](https://web.dev/progressive-web-apps/)
- [@ducanh2912/next-pwa Documentation](https://github.com/DuCanhGH/next-pwa)
- [PWA Install Criteria](https://web.dev/install-criteria/)

## Maintenance

### Regular Checks

1. **Test install flow monthly** on different devices
2. **Monitor service worker updates** after deployments
3. **Check manifest validity** using Chrome DevTools
4. **Review user feedback** about installation experience

### Updates

When updating the PWA:

1. Update version in `manifest.json` if needed
2. Test on multiple devices and browsers
3. Verify service worker updates correctly
4. Check that existing installations update properly

---

**Last Updated:** January 31, 2026
**Version:** 1.0.0
